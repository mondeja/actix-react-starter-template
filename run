#!/usr/bin/env sh

: '
  Script that runs the application.

  Environment variables (default values):

  - HOST (127.0.0.1): Host used to serve the website.
  - PORT (8080): Port used to serve the website.
  - RUST_LOG (actix_web=info): Server logging level.
  - RELEASE: If not empty, build code for production environment.
  - RECREATE: If not empty, recreate from scratch the specified environment
      compilations. Accept a comma separated string, being "server" and
      "client" the possible values.
  - SOURCING: If not empty, the main entry point of the script will not be
      executed, so you can source it.
'

configure_script() {
  set -e

  # environment variables
  if [ -z "$HOST" ]; then
    HOST="127.0.0.1"
  fi

  if [ -z "$PORT" ]; then
    PORT="8080"
  fi

  if [ -z "$RUST_LOG" ]; then
    RUST_LOG="actix_web=info"
  fi
}

info() {
  printf "[INFO] %s\n" "$1"
}

build_server() {
  if printf "%s" "$RECREATE" | grep -q "server"; then
    if [ -d target ]; then
      msg="Recreating"
    else
      msg="Building"
    fi
    rm -rf target
  else
    msg="Building"
  fi

  package_name="$(< Cargo.toml grep 'name = ' | head -n 1 | cut -d'"' -f2)"
  if [ -z "$RELEASE" ]; then
    msg="$msg development"
  else
    msg="$msg production"
  fi
  msg="$msg server..."
  info "$msg"

  if [ -z "$RELEASE" ]; then
    cargo build
    target_dirname="debug"
  else
    cargo build --release
    target_dirname="release"
  fi
  TARGET_BIN="./target/$target_dirname/$package_name"
  printf "\n"
}

build_client() {
  cd client

  if printf "%s" "$RECREATE" | grep -q "client"; then
    if [ -d node_modules ]; then
      msg="Recreating"
    else
      msg="Building"
    fi

    rm -rf node_modules
  else
    msg="Building"
  fi

  if [ -z "$RELEASE" ]; then
    msg="$msg development"
  else
    msg="$msg production"
  fi
  msg="$msg client..."
  info "$msg"

  if [ ! -d "node_modules" ]; then
    npm install
  fi

  RELEASE="$RELEASE" ./node_modules/.bin/webpack
  cd ..
  printf "\n"
}

build() {
  build_server
  build_client
}

run_app() {
  HOST="$HOST" PORT="$PORT" RUST_LOG="$RUST_LOG" "$TARGET_BIN"
}

main() {
  configure_script
  build
  run_app
}

if [ -z "$SOURCING" ]; then
  main
fi